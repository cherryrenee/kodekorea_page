---
description: 채팅 위젯에 Supabase를 연결하여 실시간 익명 채팅 기능을 구현하는 절차
---

# Supabase 채팅 기능 구현 계획

이 워크플로우는 현재 프론트엔드 전용인 `ChatWidget` 컴포넌트를 Supabase와 연동하여 실제 작동하는 실시간 채팅으로 업그레이드하는 과정을 담고 있습니다.

## 1. 사전 준비 (사용자 작업)
사용자가 Supabase 대시보드에서 다음 정보를 발급받아 `.env` 파일에 저장해야 합니다.
1. [Supabase](https://supabase.com/) 회원가입 및 새 프로젝트 생성
2. 프로젝트 설정 > API 메뉴에서 `URL` 및 `anon public key` 확보
3. 프로젝트 루트에 `.env` 파일 생성 후 키 입력:
   ```
   VITE_SUPABASE_URL=your_project_url
   VITE_SUPABASE_ANON_KEY=your_anon_key
   ```

## 2. 라이브러리 설치
터미널에서 Supabase 클라이언트 라이브러리를 설치합니다.
```bash
npm install @supabase/supabase-js
```

## 3. Supabase 클라이언트 초기화
`src/lib` 폴더를 생성하고 `supabaseClient.ts` 파일을 만들어 클라이언트 인스턴스를 설정합니다.
- 환경 변수에서 URL과 키를 불러와 `createClient` 초기화

## 4. 데이터베이스 테이블 생성 (Supabase SQL Editor)
SQL Editor에서 채팅 메시지를 저장할 테이블을 생성합니다.
```sql
create table messages (
  id bigint generated by default as identity primary key,
  session_id text not null, -- 익명 사용자 구분을 위한 브라우저 세션 ID
  content text not null,
  is_admin boolean default false, -- 관리자 답변 여부
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- (선택) 실시간 구독 활성화
alter publication supabase_realtime add table messages;
```

## 5. 채팅 위젯 컴포넌트 수정 (`src/components/ChatWidget.tsx`)
1. **상태 관리 수정**: 기존 로컬 상태(`messages`) 대신 Supabase 실시간 구독 데이터와 연동.
2. **세션 ID 생성**: 사용자가 처음 접속할 때 `uuid` 등을 이용해 로컬 스토리지에 고유 세션 ID 생성 및 저장.
3. **메시지 전송 로직 (`sendMessage`)**:
   - Supabase `messages` 테이블에 `{ content, session_id }`를 `insert`.
4. **실시간 수신 로직 (`useEffect`)**:
   - Supabase `subscribe`를 통해 `messages` 테이블의 변경 사항(새 메시지)을 실시간 감지.
   - 내 `session_id`와 일치하는 메시지만 필터링하여 화면에 표시.

## 6. (부록) 관리자 응대 방법 안내
관리자 페이지 개발 전까지는 Supabase 대시보드의 'Table Editor'에서 직접 답변을 달 수 있습니다.
- `messages` 테이블에서 해당 고객의 `session_id`로 행을 추가.
- `content`: 답변 내용, `is_admin`: true로 설정하여 저장하면 고객 화면에 실시간으로 뜸.
